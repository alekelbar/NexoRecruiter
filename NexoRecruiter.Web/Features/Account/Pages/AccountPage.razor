@page "/auth/account"
@using Microsoft.AspNetCore.Identity
@using NexoRecruiter.Application.DTOs.Account
@using NexoRecruiter.Domain.Services.Auth.ValueObjects
@using NexoRecruiter.Domain.interfaces.Auth
@using NexoRecruiter.Web.Features.Auth.Models
@using NexoRecruiter.Web.Features.Dashboard.Layouts
@attribute [Authorize]
@layout DashboardLayout
@inject INexoUserManager _nexoUserManager
@inject ISnackbar Snackbar
@inject NavigationManager navigationManager

<MudContainer Class="nexo-account-page">
    <MudText Class="nexo-account-page__text-title" Typo="Typo.h5" Align="Align.Start" Color="Color.Secondary">
        Account Settings
    </MudText>
    <MudGrid>
        <MudItem xs="12">
            <MudCard Class="pa-4 gap-4">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body1" Class="mb-2 mt-4">FullName</MudText>
                        <MudTextField T="string" Disabled="@isNotEditable" Placeholder="Nombre completo"
                                      Variant="Variant.Filled" @bind-Value="userAccountDTO.FullName" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body1" Class="mb-2 mt-4">Nickname</MudText>
                        <MudTextField T="string" Disabled="@isNotEditable" Placeholder="Nickname"
                                      Variant="Variant.Filled" @bind-Value="userAccountDTO.Nickname" OnBlur="ValidateNickname" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body1" Class="mb-2 mt-4">Job Title</MudText>
                        <MudTextField T="string" Disabled="@isNotEditable" Placeholder="Puesto" Variant="Variant.Filled"
                                      @bind-Value="userAccountDTO.JobTitle" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body1" Class="mb-2 mt-4">Created at</MudText>
                        <MudTextField T="string" Value="@CreatedAtText" Variant="Variant.Filled" Disabled="true" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body1" Class="mt-4">Last Login</MudText>
                        <MudTextField T="string" Value="@LastLoginText" Variant="Variant.Filled" Disabled="true" />
                    </MudItem>
                </MudGrid>
                <MudGrid Spacing="8" Justify="Justify.FlexStart" Class="mt-4">
                    <MudItem xs="12" lg="8">
                        <MudStack Row Justify="Justify.FlexStart" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ToggleEdit"
                                       EndIcon="@Icons.Material.Filled.Edit">
                                Edit
                            </MudButton>
                            <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="SaveChanges"
                                       Disabled="@isNotEditable" EndIcon="@Icons.Material.Filled.Save">
                                Save
                            </MudButton>
                            <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="GoToChangePassword">
                                Change Password
                            </MudButton>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>


@code {
    [CascadingParameter(Name = "CurrentUser")]
    public NexoUser? CurrentUser { get; set; }
    [CascadingParameter(Name = "DashboardLayout")]
    public DashboardLayout? dashboardLayout { get; set; }
    private UserAccountDTO userAccountDTO { get; set; } = new UserAccountDTO();

    private bool isNotEditable = true;
    private static readonly System.Globalization.CultureInfo SpanishCulture =
        System.Globalization.CultureInfo.GetCultureInfo("es-ES");

    private string CreatedAtText =>
        userAccountDTO.CreatedAt?.ToString("dd 'de' MMMM 'de' yyyy", SpanishCulture) ?? "";

    private string LastLoginText => GetRelativeTime(userAccountDTO.LastLoginAt ?? DateTime.Now);

    private string AvatarInitial
    {
        get
        {
            var name = CurrentUser?.FullName ?? CurrentUser?.NickName ?? "";
            return string.IsNullOrWhiteSpace(name) ? "" : name.Substring(0, 1);
        }
    }

    public void ToggleEdit()
    {
        isNotEditable = !isNotEditable;
    }

    public void GoToChangePassword()
    {
        navigationManager.NavigateTo(AppRoutes.ChangePassword);
    }

    private bool IsNicknameValid => !string.IsNullOrWhiteSpace(userAccountDTO.Nickname) &&
!userAccountDTO.Nickname.Contains(" ");

    public async Task SaveChanges()
    {
        if (!IsNicknameValid)
        {
            Snackbar.Add("El nickname no puede contener espacios", Severity.Error);
            return;
        }

        CurrentUser!.FullName = userAccountDTO.FullName;
        CurrentUser!.JobTitle = userAccountDTO.JobTitle;
        CurrentUser!.NickName = userAccountDTO.Nickname;

        var result = await _nexoUserManager.UpdateUserAsync(CurrentUser!);

        if (result)
        {
            Snackbar.Add("Tus cambios fueron guardados correctamente", Severity.Success, config =>
            {
                config.VisibleStateDuration = 3000;
                config.ShowCloseIcon = true;
                config.Icon = Icons.Material.Filled.CheckCircle;
            });
        }
        else
        {
            Snackbar.Add("Ocurrió un error al guardar tus cambios", Severity.Error, config =>
            {
                config.VisibleStateDuration = 5000;
                config.ShowCloseIcon = true;
                config.Icon = Icons.Material.Filled.Error;
            });
        }
        isNotEditable = true;
    }

    private void ValidateNickname()
    {
        if (!IsNicknameValid)
        {
            Snackbar.Add("El nickname no puede contener espacios", Severity.Error);
        }
    }

    protected override Task OnInitializedAsync()
    {
        if (CurrentUser is not null)
        {
            userAccountDTO = new UserAccountDTO
            {
                CreatedAt = CurrentUser?.CreatedAt.Date ?? DateTime.Now.Date,
                Email = CurrentUser?.Email ?? "",
                FullName = CurrentUser?.FullName ?? "",
                LastLoginAt = CurrentUser?.LastLoginAt?.Date ?? DateTime.Now.Date,
                JobTitle = CurrentUser?.JobTitle ?? "",
                Nickname = CurrentUser?.NickName ?? ""
            };
        }

        if (dashboardLayout is not null)
        {
            dashboardLayout.setCurrentPage("Account", path: AppRoutes.Account);
        }
        return base.OnInitializedAsync();
    }

    private string GetRelativeTime(DateTime date)
    {
        var timeSpan = DateTime.Now - date;

        if (timeSpan.TotalMinutes < 1) return "Justo ahora";
        if (timeSpan.TotalHours < 1) return $"Hace {(int)timeSpan.TotalMinutes} min";
        if (timeSpan.TotalDays < 1) return $"Hace {(int)timeSpan.TotalHours}h";
        if (timeSpan.TotalDays < 7) return $"Hace {(int)timeSpan.TotalDays} días";
        if (timeSpan.TotalDays < 30) return date.ToString("dd 'de' MMM", new System.Globalization.CultureInfo("es-ES"));

        return date.ToString("dd/MM/yyyy");
    }
}