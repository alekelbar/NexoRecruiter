@page "/change-password"
@using Microsoft.AspNetCore.Identity
@using NexoRecruiter.Application.DTOs.Auth
@using NexoRecruiter.Domain.Services.Auth
@using NexoRecruiter.Domain.Services.Auth.ValueObjects
@using NexoRecruiter.Domain.interfaces.Auth
@using NexoRecruiter.Web.Features.Auth.Models
@using NexoRecruiter.Web.Features.Dashboard.Layouts
@using System.Reflection.Metadata
@inject INexoUserManager userManager
@inject ISnackbar Snackbar
@inject NavigationManager navigationManager

@layout DashboardLayout
@attribute [Authorize]

<div class="nexo-change-password">
    <MudText Class="nexo-change-password__text-title" Typo="Typo.h5" Align="Align.Start" Color="Color.Secondary">
        Change Password
    </MudText>

    <MudPaper Class="nexo-change-password__container">
        <MudCard Elevation="0" class="nexo-change-password__login-card">
            @if (isLoading)
            {
                <MudProgressLinear Indeterminate="true" Class="mb-4" />
                <MudText Align="Align.Center">...</MudText>
            }
            else
            {
                <EditForm Model="resetForm" OnValidSubmit="SubmitResetPassword" Class="d-flex flex-column gap-5">
                    <DataAnnotationsValidator />
                    <div>
                        <MudText Color=Color.Secondary Class="nexo-change-password__card-label">Current Password</MudText>
                        <MudTextField Class="nexo-change-password__input" @bind-Value="resetForm.CurrentPassword"
                                      Variant="Variant.Outlined" InputType="showCurrentPassword? InputType.Text: InputType.Password"
                                      Placeholder="••••••••" For="@(() => resetForm.CurrentPassword)" Disabled="isSubmitting"
                                      AdornmentIcon="showCurrentPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff"
                                      OnAdornmentClick="ToggleShowCurrentPassword" AdornmentColor="Color.Primary"
                                      Adornment="Adornment.End" />
                        <ValidationMessage For="@(() => resetForm.CurrentPassword)" />
                    </div>

                    <div>
                        <MudText Color=Color.Secondary Class="nexo-change-password__card-label">New Password</MudText>
                        <MudTextField Class="nexo-change-password__input" @bind-Value="resetForm.NewPassword"
                                      Variant="Variant.Outlined" InputType="showNewPassword? InputType.Text: InputType.Password"
                                      Placeholder="••••••••" For="@(() => resetForm.NewPassword)" Disabled="isSubmitting"
                                      AdornmentIcon="showNewPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff"
                                      OnAdornmentClick="ToggleShowNewPassword" AdornmentColor="Color.Primary"
                                      Adornment="Adornment.End" />
                        <ValidationMessage For="@(() => resetForm.NewPassword)" />
                    </div>

                    <div>
                        <MudText Color=Color.Secondary Class="nexo-change-password__card-label">Confirm Password</MudText>
                        <MudTextField Class="nexo-change-password__input" @bind-Value="resetForm.ConfirmPassword"
                                      Variant="Variant.Outlined" InputType="showConfirmPassword? InputType.Text: InputType.Password"
                                      Placeholder="••••••••" For="@(() => resetForm.ConfirmPassword)" Disabled="isSubmitting"
                                      AdornmentIcon="showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff"
                                      OnAdornmentClick="ToggleShowConfirmPassword" AdornmentColor="Color.Primary"
                                      Adornment="Adornment.End" />
                        <ValidationMessage For="@(() => resetForm.ConfirmPassword)" />
                    </div>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit"
                               FullWidth="true" Disabled="isSubmitting">
                        Reset Password
                    </MudButton>
                </EditForm>
            }
        </MudCard>
    </MudPaper>
</div>

<form @ref="logoutForm" method="post" action="/auth/logout" id="logout-form" style="display: none;">
    <AntiforgeryToken />
    <input type="hidden" name="returnUrl" value="/login" />
</form>


@code {
    [CascadingParameter(Name = "CurrentUser")]
    public NexoUser? CurrentUser { get; set; }

    private ChangePasswordDTO resetForm = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool showCurrentPassword = false;
    private bool showNewPassword = false;
    private bool showConfirmPassword = false;

    [CascadingParameter(Name = "DashboardLayout")]
    public DashboardLayout? dashboardLayout { get; set; }

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private ElementReference logoutForm;

    private async Task HandleLogout()
    {
        var form = await JS.InvokeAsync<IJSObjectReference>("eval", "document.getElementById('logout-form')");
        await form.InvokeVoidAsync("submit");
    }

    protected override void OnInitialized()
    {
        if (dashboardLayout is not null)
        {
            dashboardLayout.setCurrentPage("Change password", path: "/change-password");
        }
        isLoading = false;
    }

    private void ToggleShowCurrentPassword()
    {
        showCurrentPassword = !showCurrentPassword;
    }

    private void ToggleShowNewPassword()
    {
        showNewPassword = !showNewPassword;
    }

    private void ToggleShowConfirmPassword()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private async Task SubmitResetPassword()
    {
        // 1. Validar que las contraseñas coinciden
        if (resetForm.NewPassword != resetForm.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match", Severity.Error);
            return;
        }

        // 2. Validar complejidad (opcional, pero recomendado)
        if (resetForm.NewPassword.Length < 6)
        {
            Snackbar.Add("Password must be at least 6 characters", Severity.Error);
            return;
        }

        isSubmitting = true;
        try
        {
            var result = await userManager.ChangePasswordAsync(
                CurrentUser?.Email ?? "",
                resetForm.CurrentPassword!,
                resetForm.NewPassword!);

            if (!result)
            {
                Snackbar.Add($"Failed to change password: try again", Severity.Error);
                return;
            }

            Snackbar.Add("Password changed successfully!", Severity.Success);
            await HandleLogout();
        }
        catch
        {
            // TODO: Log exception
            Snackbar.Add($"An error occurred:", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}