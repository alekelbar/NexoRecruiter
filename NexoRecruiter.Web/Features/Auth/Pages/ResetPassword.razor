@page "/reset-password"
@using Microsoft.AspNetCore.WebUtilities
@using NexoRecruiter.Application.DTOs.Auth
@using Microsoft.AspNetCore.Identity
@using NexoRecruiter.Domain.interfaces.Auth
@using NexoRecruiter.Web.Features.Auth.Models
@using System.Text
@inject INexoUserManager nexoUserManager
@inject NavigationManager navigationManager
@inject ISnackbar Snackbar
@attribute [AllowAnonymous]
@layout AuthLayout

<MudPaper Class="nexo-reset-password">
    <MudCard Elevation="0" class="nexo-reset-password__login-card">
        <MudImage Class="nexo-reset-password__icon" Src="@Assets["images/logo-login.png"]"></MudImage>
        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
            <MudText Align="Align.Center">Validating token...</MudText>
        }
        else if (!isTokenValid)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                Invalid or expired reset link. Please request a new one.
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Href="/password-recovery">
                Request New Link
            </MudButton>
        }
        else
        {
            <MudPaper Elevation="0" Class="nexo-reset-password__text">
                <MudText Class="nexo-reset-password__text-title" Typo="Typo.h5" Align="Align.Center">
                    Reset Password
                </MudText>
            </MudPaper>

            <EditForm Model="resetForm" OnValidSubmit="SubmitResetPassword" Class="d-flex flex-column gap-5">
                <DataAnnotationsValidator />

                <div>
                    <MudText Class="nexo-reset-password__card-label">New Password</MudText>
                    <MudTextField Class="nexo-reset-password__input" @bind-Value="resetForm.NewPassword"
                                  Variant="Variant.Outlined" InputType="InputType.Password" Placeholder="••••••••"
                                  For="@(() => resetForm.NewPassword)" Disabled="isSubmitting" />
                    <ValidationMessage For="@(() => resetForm.NewPassword)" />
                </div>

                <div>
                    <MudText Class="nexo-reset-password__card-label">Confirm Password</MudText>
                    <MudTextField Class="nexo-reset-password__input" @bind-Value="resetForm.ConfirmPassword"
                                  Variant="Variant.Outlined" InputType="InputType.Password" Placeholder="••••••••"
                                  For="@(() => resetForm.ConfirmPassword)" Disabled="isSubmitting" />
                    <ValidationMessage For="@(() => resetForm.ConfirmPassword)" />
                </div>

                <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit" FullWidth="true"
                           Disabled="isSubmitting">
                    Reset Password
                </MudButton>
            </EditForm>
        }
    </MudCard>
</MudPaper>

@code {
    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    private PasswordResetConfirmDTO resetForm = new();
    private bool isLoading = true;
    private bool isTokenValid = false;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        // 1. Validar que tenemos email y token
        if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            isTokenValid = false;
            isLoading = false;
            return;
        }

        // 2. Decodificar el token, que esta en base64
        var decodedToken = nexoUserManager.DecodedResetPasswordTokenAsync(Token);

        try
        {
            // 3. Buscar usuario
            var user = await nexoUserManager.FindUserByEmailOrDefault(Email);
            if (user == null)
            {
                isTokenValid = false;
                isLoading = false;
                return;
            }

            var isValidResetPassToken = await nexoUserManager.IsValidResetPasswordToken(decodedToken, user?.Email ?? string.Empty);

            isTokenValid = isValidResetPassToken;
            resetForm.Email = Email;
            resetForm.Token = decodedToken;
        }
        catch
        {
            isTokenValid = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SubmitResetPassword()
    {
        // 1. Validar que las contraseñas coinciden
        if (resetForm.NewPassword != resetForm.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match", Severity.Error);
            return;
        }

        // 2. Validar complejidad (opcional, pero recomendado)
        if (resetForm.NewPassword.Length < 6)
        {
            Snackbar.Add("Password must be at least 6 characters", Severity.Error);
            return;
        }

        isSubmitting = true;
        try
        {
            var result = await nexoUserManager.ValidateAndConsumeResetTokenAsync(resetForm.Email!, resetForm.Token!,
resetForm.NewPassword!);
            if (!result)
            {
                Snackbar.Add($"Failed to reset password: try again", Severity.Error);
                return;
            }

            Snackbar.Add("Password reset successfully! Please login with your new password.", Severity.Success);
            navigationManager.NavigateTo("/login", replace: true);
        }
        catch
        {
            // TODO: Log exception
            Snackbar.Add($"An error occurred:", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}