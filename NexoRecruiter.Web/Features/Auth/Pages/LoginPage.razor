@page "/auth/login"
@attribute [AllowAnonymous]

@using NexoRecruiter.Application.DTOs.Auth;
@using NexoRecruiter.Domain.Services.Auth
@inject NavigationManager _navigationManager
@inject INexoAuthStateProvider _authenticationStateProvider
@inject IJSRuntime JSRuntime
@layout AuthLayout

@{
    string imageBG = $"{Assets["images/login-lateral.svg"]}";
}

<MudPaper Class="login-page-container">
    <MudContainer Elevation="0" class="login-card">

        <MudImage Class="login-icon" Src="@Assets["images/logo-login.png"]"></MudImage>
        <MudElement HtmlTag="form" id="loginForm" method="post" action="@AppRoutes.ApiLogin" class="d-flex flex-column gap-5"
                    @onsubmit="ValidateBeforeSubmit">
            <AntiforgeryToken />
            <div>
                <MudText Class="login-card__label">Email</MudText>
                <MudTextField Class="login-form__input" @bind-Value="_email" Variant="Variant.Outlined"
                              Placeholder="JonhDoe@gmail.com" InputType="InputType.Email" id="emailField" Error="@_emailError"
                              ErrorText="@_emailErrorText" />
                <input type="hidden" name="email" value="@_email" />
            </div>

            <div>
                <MudStack Row
                          Justify=Justify.SpaceBetween
                          AlignItems=AlignItems.Center>
                    <MudText Class="login-card__label">Password</MudText>
                    <MudLink Href="@AppRoutes.RequestResetPassword" Typo=Typo.caption>Forgot Password?</MudLink>
                </MudStack>
                <MudTextField Class="login-form__input"
                              @bind-Value="_password"
                              Variant="Variant.Outlined"
                              InputType="@(ShowPassword? InputType.Text: InputType.Password)"
                              Placeholder="●●●●●●●●●●●●●●"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.RemoveRedEye"
                              AdornmentColor="Color.Primary"
                              OnAdornmentClick="ShowPasswordField"
                              id="passwordField"
                              Error="@_passwordError"
                              ErrorText="@_passwordErrorText" />
                <input type="hidden" name="password" value="@_password" />
            </div>

            <MudCheckBox Class="login-form__keep-me-sign" Value="true">Keep me SignIn</MudCheckBox>

            <input type="hidden" name="returnUrl" value="@ReturnUrl" />

            <MudButton Class="btn-signup" Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">
                Login
            </MudButton>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Variant="Variant.Filled" Severity="Severity.Error">@_errorMessage</MudAlert>
            }
        </MudElement>
    </MudContainer>
</MudPaper>

@code {
    private bool ShowPassword = false;
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _errorMessage = string.Empty;

    private bool _emailError = false;
    private string _emailErrorText = string.Empty;
    private bool _passwordError = false;
    private string _passwordErrorText = string.Empty;

    [SupplyParameterFromQuery]
    [Parameter]
    public string ReturnUrl { get; set; } =AppRoutes.Dashboard;

    [SupplyParameterFromQuery]
    public string? Error { get; set; }

    private void ShowPasswordField()
    {
        ShowPassword = !ShowPassword;
    }

    private void ValidateBeforeSubmit()
    {
        // Limpiar errores previos
        _errorMessage = string.Empty;
        _emailError = false;
        _emailErrorText = string.Empty;
        _passwordError = false;
        _passwordErrorText = string.Empty;

        bool isValid = true;

        // Validar email
        if (string.IsNullOrWhiteSpace(_email))
        {
            _emailError = true;
            _emailErrorText = "El correo es requerido";
            isValid = false;
        }
        else if (!_email.Contains("@"))
        {
            _emailError = true;
            _emailErrorText = "El correo no es válido";
            isValid = false;
        }

        // Validar password
        if (string.IsNullOrWhiteSpace(_password))
        {
            _passwordError = true;
            _passwordErrorText = "La contraseña es requerida";
            isValid = false;
        }

        // Si todo válido, submit el form
        if (isValid)
        {
            SubmitForm();
        }
    }

    private async void SubmitForm()
    {
        // Submit nativo del formulario HTML
        await Task.CompletedTask;
        var form = await JSRuntime.InvokeAsync<IJSObjectReference>("eval", "document.getElementById('loginForm')");
        await form.InvokeVoidAsync("submit");
    }

    protected override void OnParametersSet()
    {
        if (Error == "1" || Error == "2")
        {
            _errorMessage = "Credenciales inválidas";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await _authenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.IsAuthenticated)
            {
                _navigationManager.NavigateTo(AppRoutes.Dashboard, replace: true);
            }
        }
    }
}