@using NexoRecruiter.Domain.Services.Auth.ValueObjects
@using NexoRecruiter.Web.Features.Dashboard.Helpers
@inject IDialogService Dialog

<MudDrawer Class="nexo-drawer p-4" Open="IsOpen" OpenChanged="Toggle" Anchor="Anchor.Start" Elevation="1"
           Variant="@DrawerVariant.Responsive">
    <MudDrawerHeader Class="dashboard-sidebar__header">
        <MudStack StretchItems="StretchItems.None">
            <MudImage Class="dashboard-sidebar__logo" Width="276" Src="@Assets[key: "images/Finebank.IO.png"]"></MudImage>
        </MudStack>
    </MudDrawerHeader>
    <MudElement HtmlTag="div" Class="nexo-drawer__content">

        <MudNavMenu>
            <MudText Typo="Typo.caption" Class="mt-4">General</MudText>

            <MudNavLink Href="/dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>

            <MudText Typo="Typo.caption" Class="mt-4">Reclutamiento</MudText>

            <MudNavLink Href="/jobs" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.WorkOutline">
                Vacantes
            </MudNavLink>

            <MudNavLink Href="/applications" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AssignmentInd">
                Aplicaciones
            </MudNavLink>

            <MudNavLink Href="/candidates" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">
                Candidatos
            </MudNavLink>

            <MudText Typo="Typo.caption" Class="mt-4">IA</MudText>

            <MudNavLink Href="/ai-evaluations" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Psychology">
                Evaluaciones IA
            </MudNavLink>

            @if (CurrentUser?.Roles?.Contains("Admin") == true)
            {
                <MudText Typo="Typo.caption" Class="mt-4">Administración</MudText>

                <MudNavLink Href="/admin/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ManageAccounts">
                    Usuarios
                </MudNavLink>

                <MudNavLink Href="/admin/settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings">
                    Configuración
                </MudNavLink>
            }

            <MudText Typo="Typo.caption" Class="mt-4">Público</MudText>

            <MudNavLink Href="/careers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Public">
                Portal de empleo
            </MudNavLink>
        </MudNavMenu>
    </MudElement>

    <MudSpacer />

    <MudStack Class="nexo-drawer__profile-info" Row>
        <MudAvatar>@((CurrentUser?.FullName ?? CurrentUser?.NickName ?? "").FirstOrDefault())</MudAvatar>
        <MudStack Spacing="0">
            <MudText Typo=Typo.body1>Alexander Barquero</MudText>
            <MudLink Href="/Account" Color=Color.Inherit>
                <MudText Typo=Typo.caption>Ver perfil</MudText>
            </MudLink>
        </MudStack>
    </MudStack>


    <MudButton OnClick="OpenDialogAsync" Class="mt-8" ButtonType=ButtonType.Button Variant=Variant.Outlined
               Color=Color.Inherit>
        Cerrar Sesión
    </MudButton>
</MudDrawer>

<form @ref="logoutForm" method="post" action="/auth/logout" id="logout-form" style="display: none;">
    <AntiforgeryToken />
    <input type="hidden" name="returnUrl" value="/login" />
</form>

@code {
    [CascadingParameter(Name = "CurrentUser")]
    public NexoUser? CurrentUser { get; set; }
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback Toggle { get; set; }

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private ElementReference logoutForm;

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    private async Task HandleLogout()
    {
        var form = await JS.InvokeAsync<IJSObjectReference>("eval", "document.getElementById('logout-form')");
        await form.InvokeVoidAsync("submit");
    }

    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = await Dialog.ShowAsync<ConfirmLogoutDialog>("¿Desea cerrar sesión?", options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await HandleLogout();
        }
    }
}