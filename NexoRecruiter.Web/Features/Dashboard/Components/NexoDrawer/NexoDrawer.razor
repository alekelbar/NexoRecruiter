@using NexoRecruiter.Application.DTOs.Auth
@using NexoRecruiter.Domain.Repositories.Auth.ValueObjects
@using NexoRecruiter.Web.Features.Auth.Components.ConfirmLogoutDialog
@using NexoRecruiter.Web.Features.Dashboard.Helpers
@inject IDialogService Dialog

<MudDrawer Class="nexo-drawer p-4" Open="IsOpen" OpenChanged="Toggle" Anchor="Anchor.Start" Elevation="1"
           Variant="@DrawerVariant.Responsive">
    <MudDrawerHeader Class="sidebar__header">
        <MudText Typo="Typo.h6" Class="m-0">Nexo Recruiter</MudText>
        <MudText Typo="Typo.body2">ai assistant</MudText>
    </MudDrawerHeader>
    <MudPaper Elevation="0" Class="nexo-drawer__content">
        <MudNavMenu>
            <MudText Typo="Typo.body2" Class="my-2">General</MudText>

            <MudNavLink Href="@AppRoutes.Dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
                Dashboard
            </MudNavLink>

            <MudText Typo="Typo.body2" Class="my-2">Reclutamiento</MudText>

            <MudNavLink Href="@AppRoutes.Jobs" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Work">
                Vacantes
            </MudNavLink>

            <MudNavLink Href="@AppRoutes.Applications" Match="NavLinkMatch.Prefix"
                        Icon="@Icons.Material.Filled.CheckCircle">
                Aplicaciones
            </MudNavLink>

            <MudNavLink Href="@AppRoutes.Candidates" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Groups">
                Candidatos
            </MudNavLink>

            <MudText Typo="Typo.body2" Class="my-2">IA</MudText>

            <MudNavLink Href="@AppRoutes.AIEvaluations" Match="NavLinkMatch.Prefix"
                        Icon="@Icons.Material.Filled.AutoAwesome">
                Evaluaciones IA
            </MudNavLink>

            @if (CurrentUser?.Roles?.Contains("Admin") == true)
            {
                <MudText Typo="Typo.body2" Class="my-2">Administración</MudText>

                <MudNavLink Href="@AppRoutes.Users" Match="NavLinkMatch.Prefix"
                            Icon="@Icons.Material.Filled.SupervisorAccount">
                    Usuarios
                </MudNavLink>

                <MudNavLink Href="@AppRoutes.Settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Tune">
                    Configuración
                </MudNavLink>
            }

            <MudText Typo="Typo.body2" Class="my-2">Público</MudText>

            @* El portal del empleo es el root de la aplicación, siempre es la cara visible y donde se coloca el
            dominio, por eso es / *@
            <MudNavLink Href="@AppRoutes.PublicPortal" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Language">
                Portal de empleo
            </MudNavLink>
        </MudNavMenu>
    </MudPaper>

    <MudSpacer />

    <MudStack Class="nexo-drawer__profile-info" Row>
        <MudAvatar>@((CurrentUser?.FullName ?? CurrentUser?.Email ?? "").FirstOrDefault())</MudAvatar>
        <MudStack Spacing="0">
            <MudText Typo=Typo.body1>@(CurrentUser?.FullName ?? CurrentUser?.Email ?? "")</MudText>
            <MudLink Href="@AppRoutes.Account" Color=Color.Inherit>
                <MudText Typo=Typo.body2>Ver perfil</MudText>
            </MudLink>
        </MudStack>
    </MudStack>


    <MudButton OnClick="OpenDialogAsync" Class="mt-8" ButtonType=ButtonType.Button Variant=Variant.Outlined
               Color=Color.Inherit>
        Cerrar Sesión
    </MudButton>
</MudDrawer>

<form @ref="logoutForm" method="post" action="@AppRoutes.ApiLogout" id="logout-form" style="display: none;">
    <AntiforgeryToken />
    <input type="hidden" name="returnUrl" value="@AppRoutes.Login" />
</form>

@code {
    [CascadingParameter(Name = "CurrentUser")]
    public AppUserDTO? CurrentUser { get; set; }
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback Toggle { get; set; }

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private ElementReference logoutForm;

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    private async Task HandleLogout()
    {
        var form = await JS.InvokeAsync<IJSObjectReference>("eval", "document.getElementById('logout-form')");
        await form.InvokeVoidAsync("submit");
    }

    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, NoHeader = true };
        var dialog = await Dialog.ShowAsync<ConfirmLogoutDialog>("¿Desea cerrar sesión?", options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await HandleLogout();
        }
    }
}