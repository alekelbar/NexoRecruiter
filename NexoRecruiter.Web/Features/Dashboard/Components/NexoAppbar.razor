@using NexoRecruiter.Domain.Services.Auth.ValueObjects
@using NexoRecruiter.Domain.interfaces.Auth
@using NexoRecruiter.Web.Features.Dashboard.Helpers
@inject NavigationManager navigationManager
@inject INexoUserManager _nexoUserManager
@inject ISnackbar Snackbar

<MudAppBar Class="nexo-appbar" Color="Color.Default" Fixed Elevation="0">
    @if (isDashboard)
    {
        <MudText Class="mr-1 greet-text" Typo="Typo.caption">Hello @(CurrentUser?.FullName ?? "")</MudText>
    }
    <MudIconButton OnClick="drawerController!.Toggle"
                   Icon="@(drawerController.IsOpen ? Icons.Material.Filled.KeyboardDoubleArrowLeft: Icons.Material.Filled.KeyboardDoubleArrowRight)"
                   aria-label="Open Drawer" />
    <MudText Typo="Typo.caption">@DateTime.Now.ToString("MMMM dd, yyyy")</MudText>
    <MudSpacer />
    <MudMenu Label="Open menu" Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit">
        @if (CurrentUser?.EmailConfirmed ?? false)
        {
            <MudMenuItem Label="No new notifications" Disabled="true" />
        }
        else
        {
            <MudMenuItem Label="Please confirm your email to receive notifications" OnClick="RequestEmailConfirmation"
                         Disabled="@(CurrentUser?.EmailConfirmed ?? true)" />
        }
    </MudMenu>
</MudAppBar>

@code {
    [CascadingParameter(Name = "CurrentUser")]
    public NexoUser? CurrentUser { get; set; }
    public bool isDashboard = false;
    [Parameter]
    public DrawerController? drawerController { get; set; }

    protected override void OnInitialized()
    {
        navigationManager.LocationChanged += OnLocationChanged;
        UpdateDashboardState();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateDashboardState();
        StateHasChanged();
    }

    private void UpdateDashboardState()
    {
        var relativePath = navigationManager.ToBaseRelativePath(navigationManager.Uri);
        Console.WriteLine($"URL relativa: {relativePath}");
        isDashboard = relativePath.Contains("dashboard");
    }

    public async Task RequestEmailConfirmation()
    {
        await _nexoUserManager.RequestEmailConfirmationTokenAsync();
        Snackbar.Add("Se ha enviado un correo de confirmación a tu dirección de email.", Severity.Info, config =>
        {
            config.VisibleStateDuration = 5000;
            config.ShowCloseIcon = true;
            config.Icon = Icons.Material.Filled.Email;
        });
    }

    public void Dispose()
    {
        navigationManager.LocationChanged -= OnLocationChanged;
    }
}